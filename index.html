<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê·€ì—¬ìš´ ë™ë¬¼ íƒ€ì ì—°ìŠµ</title>
    <!-- Google AdSense Script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6412479119627050"
     crossorigin="anonymous"></script>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for cute font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&display=swap" rel="stylesheet">
    <!-- Tone.js for background music -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* Apply custom font and background */
        body {
            font-family: 'Gaegu', cursive;
            background-color: #e0f2fe; /* Light sky blue */
            /* Complex cloud background */
            background-image:
                radial-gradient(circle at 15% 50%, rgba(255, 255, 255, 0.7) 3%, transparent 4%),
                radial-gradient(circle at 85% 30%, rgba(255, 255, 255, 0.7) 3.5%, transparent 4%),
                radial-gradient(circle at 45% 80%, rgba(255, 255, 255, 0.7) 2.5%, transparent 3%),
                radial-gradient(circle at 5% 20%, rgba(255, 255, 255, 0.7) 3%, transparent 4%),
                radial-gradient(circle at 95% 70%, rgba(255, 255, 255, 0.7) 2%, transparent 2.5%);
            background-size: 40em 40em, 50em 50em, 30em 30em, 60em 60em, 35em 35em;
            background-repeat: no-repeat;
        }

        .game-container {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            position: relative;
        }
        
        #word-display {
            font-size: 2.5rem;
            letter-spacing: 0.1em;
        }

        #word-input {
            font-size: 1.5rem;
        }

        /* Animation for correct word completion */
        .correct-animation { animation: correct 0.5s ease-in-out; }
        @keyframes correct {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Animation for incorrect input */
        @keyframes shake {
          10%, 90% { transform: translateX(-1px); }
          20%, 80% { transform: translateX(2px); }
          30%, 50%, 70% { transform: translateX(-4px); }
          40%, 60% { transform: translateX(4px); }
        }
        .shake-animation {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* --- Rabbit Character Styles --- */
        #character {
            width: 80px;
            height: 80px;
            background-color: #f1f5f9;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            position: relative;
            margin: 20px auto 0 auto;
            border: 4px solid #e11d48;
        }
        #character::before, #character::after {
            content: '';
            position: absolute;
            width: 25px;
            height: 60px;
            background: #f1f5f9;
            border: 4px solid #e11d48;
            border-bottom: none;
            border-radius: 50% 50% 0 0;
            top: -45px;
        }
        #character::before { left: 5px; transform: rotate(-20deg); }
        #character::after { right: 5px; transform: rotate(20deg); }
        #character-eyes { position: absolute; top: 45%; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; }
        .eye { width: 8px; height: 12px; background-color: #333; border-radius: 50%; }
        #character-mouth { width: 25px; height: 12px; border: 3px solid #333; border-top-color: transparent; border-radius: 0 0 25px 25px; position: absolute; bottom: 25%; left: 50%; transform: translateX(-50%); }
        .item-slot { position: absolute; width: 100%; height: 100%; top: 0; left: 0; }
        .hat-style-1 { width: 50px; height: 20px; background-color: #ef4444; border-radius: 10px 10px 0 0; position: absolute; top: -18px; left: 50%; transform: translateX(-50%) rotate(-5deg); border: 3px solid #b91c1c; }
        .glasses-style-1 { width: 70px; height: 20px; border: 5px solid #000; border-radius: 15px; position: absolute; top: 35%; left: 50%; transform: translateX(-50%); }

        .coin-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #f59e0b;
            font-size: 1.75rem;
            font-weight: bold;
            animation: float-up 1s ease-out forwards;
            white-space: nowrap;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        @keyframes float-up {
            from { opacity: 1; transform: translate(-50%, -50%); }
            to { opacity: 0; transform: translate(-50%, -150%); }
        }

        /* --- Keyboard Styles --- */
        #keyboard {
            margin-top: 1rem;
            padding: 1rem;
            background: #cbd5e1;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .key {
            background-color: #f8fafc;
            color: #475569;
            border-radius: 0.5rem;
            padding: 0.5rem;
            min-width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
            border-bottom: 3px solid #94a3b8;
            transition: all 0.1s ease;
            cursor: pointer;
        }
        .key:active {
            transform: translateY(2px);
            border-bottom-width: 1px;
        }
        .key[data-key="space"] {
            min-width: 12rem;
        }
        .key.key-highlight {
            background-color: #fef08a; /* Bright yellow for highlight */
            border-color: #facc15;
            color: #ca8a04;
            transform: translateY(-2px);
        }
        .key.key-highlight:active {
            transform: translateY(2px);
            border-bottom-width: 1px;
        }
        .key-active {
            transform: translateY(2px);
            border-bottom-width: 1px;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="game-container text-center p-4 md:p-6 bg-white/70 rounded-3xl shadow-2xl max-w-5xl w-full">
        <button id="music-toggle-btn" class="absolute top-4 right-4 text-3xl hover:scale-110 transition-transform">ğŸ”ˆ</button>
        <h1 class="text-4xl md:text-5xl font-bold text-sky-600 mb-2">ê·€ì—¬ìš´ ë™ë¬¼ íƒ€ì ì—°ìŠµ</h1>
        <p class="text-gray-500 mb-4 text-lg">ë™ë¬¼ ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜ íƒ€ì ì‹¤ë ¥ì„ í‚¤ì›Œë´ìš”!</p>

        <!-- Level Selection Screen -->
        <div id="level-selection" class="flex flex-col sm:flex-row justify-center gap-3 md:gap-4 mb-6">
            <button data-level="easy" class="level-btn bg-green-400 hover:bg-green-500 text-white font-bold py-3 px-6 rounded-full transition-transform transform hover:scale-105 text-xl">ğŸ£ ìª¼ê¼¬ë¯¸ (ë‹¨ì–´)</button>
            <button data-level="medium" class="level-btn bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 px-6 rounded-full transition-transform transform hover:scale-105 text-xl">ğŸ° ì«‘ì•Œì«‘ì•Œ (ì§§ì€ ê¸€)</button>
            <button data-level="hard" class="level-btn bg-red-400 hover:bg-red-500 text-white font-bold py-3 px-6 rounded-full transition-transform transform hover:scale-105 text-xl">ğŸ¦ ì²™ì²™ë°•ì‚¬ (ê¸´ ê¸€)</button>
        </div>

        <!-- Main Game Area (initially hidden) -->
        <div id="game-area" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <!-- Character & Coins -->
                <div class="bg-rose-100 p-4 rounded-xl flex flex-col items-center justify-center relative min-h-[200px]">
                    <div id="coin-effect-container" class="absolute inset-0 pointer-events-none z-10"></div>
                    <div id="character">
                        <div id="character-eyes"><div class="eye"></div><div class="eye"></div></div>
                        <div id="character-mouth"></div>
                        <div id="hat-slot" class="item-slot"></div>
                        <div id="glasses-slot" class="item-slot"></div>
                    </div>
                    <div class="mt-3 text-rose-800 text-xl font-bold">ğŸ’° <span id="coin-display">0</span> ì½”ì¸</div>
                    <button id="shop-open-btn" class="mt-2 bg-rose-500 hover:bg-rose-600 text-white font-bold py-1 px-4 rounded-full text-sm">ê¾¸ë¯¸ê¸°</button>
                </div>

                <!-- Stats -->
                <div class="col-span-1 md:col-span-2 bg-sky-100 rounded-xl p-4 grid grid-cols-2 gap-4 text-sky-800 text-lg md:text-xl content-center">
                    <div>ì •í™•ë„: <span id="accuracy" class="font-bold">100</span>%</div>
                    <div>íƒ€ìˆ˜: <span id="wpm" class="font-bold">0</span></div>
                </div>
            </div>

            <!-- Image Display Area -->
            <div id="image-display" class="text-7xl mb-2 min-h-[80px] flex items-center justify-center"></div>

            <div id="word-display-container" class="bg-white p-6 md:p-8 rounded-2xl shadow-inner mb-4 min-h-[120px] flex items-center justify-center">
                <div id="word-display" class="font-bold text-gray-700 leading-relaxed">ë ˆë²¨ì„ ì„ íƒí•˜ê³  ì‹œì‘í•˜ì„¸ìš”!</div>
            </div>

            <input type="text" id="word-input" class="w-full p-4 border-4 border-sky-300 rounded-xl text-center focus:outline-none focus:border-sky-500 transition" placeholder="ì—¬ê¸°ì— ë”°ë¼ì¹˜ê³  Enter!" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" disabled>
            <div id="warning-message" class="text-red-500 font-bold mt-2 h-6 text-xl"></div>
            
            <!-- Visual Keyboard -->
            <div id="keyboard">
                <div class="keyboard-row">
                    <div class="key" data-key="q">ã…‚</div><div class="key" data-key="w">ã…ˆ</div><div class="key" data-key="e">ã„·</div><div class="key" data-key="r">ã„±</div><div class="key" data-key="t">ã……</div><div class="key" data-key="y">ã…›</div><div class="key" data-key="u">ã…•</div><div class="key" data-key="i">ã…‘</div><div class="key" data-key="o">ã…</div><div class="key" data-key="p">ã…”</div>
                </div>
                <div class="keyboard-row">
                    <div class="key" data-key="a">ã…</div><div class="key" data-key="s">ã„´</div><div class="key" data-key="d">ã…‡</div><div class="key" data-key="f">ã„¹</div><div class="key" data-key="g">ã…</div><div class="key" data-key="h">ã…—</div><div class="key" data-key="j">ã…“</div><div class="key" data-key="k">ã…</div><div class="key" data-key="l">ã…£</div>
                </div>
                <div class="keyboard-row">
                    <div class="key" data-key="shift">Shift</div><div class="key" data-key="z">ã…‹</div><div class="key" data-key="x">ã…Œ</div><div class="key" data-key="c">ã…Š</div><div class="key" data-key="v">ã…</div><div class="key" data-key="b">ã… </div><div class="key" data-key="n">ã…œ</div><div class="key" data-key="m">ã…¡</div><div class="key" data-key="shift">Shift</div>
                </div>
                <div class="keyboard-row">
                    <div class="key" data-key="space">Space</div>
                </div>
            </div>

            <button id="restart-btn" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-xl transition-transform transform hover:scale-105">ë‹¤ë¥¸ ë ˆë²¨ ì„ íƒ</button>
        </div>
    </div>

    <!-- Modals (Message Box & Shop) -->
    <div id="message-box" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-lg text-center" id="message-content">
            <h2 id="message-title" class="text-3xl font-bold mb-4"></h2>
            <p id="message-text" class="text-lg mb-6"></p>
            <button id="message-close-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">í™•ì¸</button>
        </div>
    </div>
    <div id="shop-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-amber-50 w-full max-w-2xl p-6 rounded-2xl shadow-lg text-center relative">
            <h2 class="text-3xl font-bold text-amber-800 mb-4">âœ¨ ê¾¸ë¯¸ê¸° ìƒì  âœ¨</h2>
            <p class="text-lg text-amber-700 font-bold mb-4">ğŸ’° <span id="shop-coin-display">0</span> ì½”ì¸</p>
            <div id="shop-items-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto p-2"></div>
            <button id="shop-close-btn" class="absolute top-4 right-4 bg-red-500 hover:bg-red-600 text-white font-bold w-8 h-8 rounded-full text-lg">X</button>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const levelSelection = document.getElementById('level-selection');
        const gameArea = document.getElementById('game-area');
        const wordDisplay = document.getElementById('word-display');
        const imageDisplay = document.getElementById('image-display');
        const wordInput = document.getElementById('word-input');
        const warningMessage = document.getElementById('warning-message');
        const accuracyEl = document.getElementById('accuracy');
        const wpmEl = document.getElementById('wpm');
        const restartBtn = document.getElementById('restart-btn');
        const messageBox = document.getElementById('message-box');
        const messageCloseBtn = document.getElementById('message-close-btn');
        const coinDisplay = document.getElementById('coin-display');
        const shopCoinDisplay = document.getElementById('shop-coin-display');
        const shopOpenBtn = document.getElementById('shop-open-btn');
        const shopModal = document.getElementById('shop-modal');
        const shopCloseBtn = document.getElementById('shop-close-btn');
        const shopItemsGrid = document.getElementById('shop-items-grid');
        const hatSlot = document.getElementById('hat-slot');
        const glassesSlot = document.getElementById('glasses-slot');
        const musicToggleBtn = document.getElementById('music-toggle-btn');
        const keyboardKeys = document.querySelectorAll('.key');

        // --- Word, Emoji & Shop Data ---
        const words = {
            easy: ['ê°œ', 'ê³°', 'ì†Œ', 'ë§', 'ì–‘', 'ì¥', 'ë‹­', 'ìš©', 'ë±€', 'í† ë¼', 'ê³ ì–‘ì´', 'ê°•ì•„ì§€', 'ë³‘ì•„ë¦¬', 'ì†¡ì•„ì§€', 'ì‚¬ì', 'í˜¸ë‘ì´', 'ì½”ë¼ë¦¬', 'ê¸°ë¦°', 'í•˜ë§ˆ', 'ì•…ì–´', 'ì›ìˆ­ì´', 'ë‹¤ëŒì¥', 'í­ê·„', 'ì–¼ë£©ë§'],
            medium: ['ê¹¡ì¶©ê¹¡ì¶© í† ë¼ê°€ ë›°ì–´ë†€ì•„ìš”.', 'ê·€ì—¬ìš´ ì•„ê¸° ê³ ì–‘ì´ê°€ ì ì„ ììš”.', 'ì–´ë¯¸ ë‹­ì´ ë³‘ì•„ë¦¬ë“¤ì„ í’ˆê³  ìˆì–´ìš”.', 'ì½”ë¼ë¦¬ê°€ ê¸´ ì½”ë¡œ ë¬¼ì„ ë¿œì–´ìš”.', 'ë‹¤ëŒì¥ê°€ ë„í† ë¦¬ë¥¼ ë§›ìˆê²Œ ë¨¹ì–´ìš”.', 'ì–¼ë£©ë§ì˜ ì¤„ë¬´ëŠ¬ê°€ ë©‹ì ¸ìš”.', 'ì•„ê¸° ê³°ì´ ì—„ë§ˆ ê³°ì„ ë”°ë¼ê°€ìš”.', 'ëª©ì´ ê¸´ ê¸°ë¦°ì´ ë‚˜ë­‡ìì„ ë¨¹ì–´ìš”.', 'ì—°ëª» ì† ê°œêµ¬ë¦¬ê°€ ë…¸ë˜ë¥¼ ë¶ˆëŸ¬ìš”.', 'ë’¤ëš±ë’¤ëš± í­ê·„ë“¤ì´ ê±¸ì–´ê°€ìš”.'],
            hard: ['ê¹Šì€ ìˆ²ì† ì‘ì€ ê³µí„°ì—ì„œ ë™ë¬¼ ì¹œêµ¬ë“¤ì´ ëª¨ì—¬ ìŒì•…íšŒë¥¼ ì—´ì—ˆì–´ìš”.', 'ë…¸ë˜ë¥¼ ê°€ì¥ ì˜í•˜ëŠ” ê¾€ê¼¬ë¦¬ê°€ ì•„ë¦„ë‹¤ìš´ ëª©ì†Œë¦¬ë¡œ ë…¸ë˜ë¥¼ ì‹œì‘í–ˆì–´ìš”.', 'ê·¸ëŸ¬ì í’€ë²Œë ˆë“¤ì´ ì˜ˆìœ í™”ìŒì„ ë„£ì—ˆê³ , ë”±ë”°êµ¬ë¦¬ëŠ” ë‚˜ë¬´ë¥¼ ìª¼ë©° ì‹ ë‚˜ëŠ” ë¦¬ë“¬ì„ ë§Œë“¤ì—ˆë‹µë‹ˆë‹¤.', 'í´ì§í´ì§ ê°œêµ¬ë¦¬ë“¤ì€ í•©ì°½ì„ í•˜ê³ , ë©ì¹˜ í° ê³° ì•„ì €ì”¨ëŠ” ë©‹ì§„ ì¶¤ì„ ì¶”ì—ˆì–´ìš”.', 'ìˆ²ì†ì˜ ëª¨ë“  ë™ë¬¼ë“¤ì´ í•¨ê»˜ ì¦ê¸°ëŠ” ì •ë§ ë©‹ì§„ ìŒì•…íšŒì˜€ë‹µë‹ˆë‹¤.']
        };
        const wordToEmoji = {
            'ê°œ': 'ğŸ¶', 'ê³°': 'ğŸ»', 'ì†Œ': 'ğŸ®', 'ë§': 'ğŸ´', 'ì–‘': 'ğŸ‘', 'ì¥': 'ğŸ­', 'ë‹­': 'ğŸ”', 'ìš©': 'ğŸ²', 'ë±€': 'ğŸ', 'í† ë¼': 'ğŸ°',
            'ê³ ì–‘ì´': 'ğŸ±', 'ê°•ì•„ì§€': 'ğŸ¶', 'ë³‘ì•„ë¦¬': 'ğŸ£', 'ì†¡ì•„ì§€': 'ğŸ®', 'ì‚¬ì': 'ğŸ¦', 'í˜¸ë‘ì´': 'ğŸ¯', 'ì½”ë¼ë¦¬': 'ğŸ˜', 'ê¸°ë¦°': 'ğŸ¦’',
            'í•˜ë§ˆ': 'ğŸ¦›', 'ì•…ì–´': 'ğŸŠ', 'ì›ìˆ­ì´': 'ğŸµ', 'ë‹¤ëŒì¥': 'ğŸ¿ï¸', 'í­ê·„': 'ğŸ§', 'ì–¼ë£©ë§': 'ğŸ¦“', 'ê¾€ê¼¬ë¦¬': 'ğŸ¦', 'í’€ë²Œë ˆ': 'ğŸ›',
            'ë”±ë”°êµ¬ë¦¬': 'ğŸ¦', 'ê°œêµ¬ë¦¬': 'ğŸ¸', 'ì•„ì €ì”¨': 'ğŸ‘¨'
        };
        const shopItems = [
            { id: 'hat1', name: 'ë¹¨ê°„ ëª¨ì', price: 100, type: 'hat', className: 'hat-style-1' },
            { id: 'glasses1', name: 'ê²€ì • ì„ ê¸€ë¼ìŠ¤', price: 150, type: 'glasses', className: 'glasses-style-1' },
        ];

        // --- Keyboard & Hangul Data ---
        const CHOSUNG_LIST = ['ã„±','ã„²','ã„´','ã„·','ã„¸','ã„¹','ã…','ã…‚','ã…ƒ','ã……','ã…†','ã…‡','ã…ˆ','ã…‰','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
        const JUNGSUNG_LIST = ['ã…','ã…','ã…‘','ã…’','ã…“','ã…”','ã…•','ã…–','ã…—','ã…˜','ã…™','ã…š','ã…›','ã…œ','ã…','ã…','ã…Ÿ','ã… ','ã…¡','ã…¢','ã…£'];
        const JONGSUNG_LIST = ['','ã„±','ã„²','ã„³','ã„´','ã„µ','ã„¶','ã„·','ã„¹','ã„º','ã„»','ã„¼','ã„½','ã„¾','ã„¿','ã…€','ã…','ã…‚','ã…„','ã……','ã…†','ã…‡','ã…ˆ','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
        const JAMO_TO_KEY = {
            'ã„±':'r', 'ã„²':'R', 'ã„´':'s', 'ã„·':'e', 'ã„¸':'E', 'ã„¹':'f', 'ã…':'a', 'ã…‚':'q', 'ã…ƒ':'Q', 'ã……':'t', 'ã…†':'T',
            'ã…‡':'d', 'ã…ˆ':'w', 'ã…‰':'W', 'ã…Š':'c', 'ã…‹':'z', 'ã…Œ':'x', 'ã…':'v', 'ã…':'g',
            'ã…':'k', 'ã…':'o', 'ã…‘':'i', 'ã…’':'O', 'ã…“':'j', 'ã…”':'p', 'ã…•':'u', 'ã…–':'P',
            'ã…—':'h', 'ã…›':'y', 'ã…œ':'n', 'ã… ':'b', 'ã…¡':'m', 'ã…£':'l',
            ' ': 'space',
            'ã…˜': ['h', 'k'], 'ã…™': ['h', 'o'], 'ã…š': ['h', 'l'], 'ã…': ['n', 'j'], 'ã…': ['n', 'p'], 'ã…Ÿ': ['n', 'l'], 'ã…¢': ['m', 'l'],
            'ã„³': ['r', 't'], 'ã„µ': ['s', 'w'], 'ã„¶': ['s', 'g'], 'ã„º': ['f', 'r'], 'ã„»': ['f', 'a'], 'ã„¼': ['f', 'q'], 'ã„½': ['f', 't'], 'ã„¾': ['f', 'x'], 'ã„¿': ['f', 'v'], 'ã…€': ['f', 'g'], 'ã…„': ['q', 't']
        };

        // --- Game State ---
        let gameState = {};
        let currentLevelWords = [], currentWordIndex = 0, isPlaying = false, time = 0, timer, totalTyped = 0, totalCorrect = 0;
        let isMusicPlaying = false;
        let musicSynth, musicSequence, tickSound, errorSound, successSound;

        // --- Core Functions ---
        function init() {
            loadGameState();
            document.querySelectorAll('.level-btn').forEach(b => b.addEventListener('click', () => startGame(b.dataset.level)));
            wordInput.addEventListener('input', handleInput);
            wordInput.addEventListener('keydown', handleEnterPress);
            document.addEventListener('keydown', handleKeyboardPress);
            document.addEventListener('keyup', handleKeyboardRelease);
            restartBtn.addEventListener('click', () => { gameArea.classList.add('hidden'); levelSelection.classList.remove('hidden'); resetStats(); });
            messageCloseBtn.addEventListener('click', hideMessageBox);
            shopOpenBtn.addEventListener('click', openShop);
            shopCloseBtn.addEventListener('click', () => shopModal.classList.add('hidden'));
            musicToggleBtn.addEventListener('click', toggleMusic);
            shopItemsGrid.addEventListener('click', handleShopClick);
            setupSounds();
            toggleMusic(); // Start music by default
        }

        async function startGame(level) {
            if (Tone.context.state !== 'running') {
                await Tone.start();
            }
            levelSelection.classList.add('hidden');
            gameArea.classList.remove('hidden');
            currentLevelWords = [...words[level]].sort(() => 0.5 - Math.random());
            currentWordIndex = 0;
            isPlaying = false;
            resetStats();
            showNextWord();
            wordInput.value = '';
            wordInput.disabled = false;
            wordInput.focus();
        }

        function handleInput() {
            if (!isPlaying && wordInput.value.length > 0) {
                isPlaying = true;
                timer = setInterval(updateTime, 1000);
            }
            const targetText = currentLevelWords[currentWordIndex] || '';
            const typedText = wordInput.value;
            
            if (tickSound) tickSound.triggerAttackRelease('C5', '16n');
            warningMessage.textContent = '';

            // Update text color on the display
            const displaySpans = wordDisplay.querySelectorAll('span');
            displaySpans.forEach((charSpan, index) => {
                const typedChar = typedText[index];
                if (typedChar == null) {
                    charSpan.className = '';
                } else if (typedChar === charSpan.innerText) {
                    charSpan.className = 'text-green-500 font-bold';
                }
            });

            if (typedText === targetText) {
                wordInput.classList.add('border-green-500', 'focus:border-green-500');
            } else {
                wordInput.classList.remove('border-green-500'); // Removed the focus class removal
            }

            updateKeyboardHighlight();
            updateStats();
        }

        function handleEnterPress(event) {
            if (event.key !== 'Enter') return;
            event.preventDefault();
            const currentTypedText = wordInput.value;
            const targetText = currentLevelWords[currentWordIndex] || '';

            if (currentTypedText === targetText && targetText.length > 0) {
                if (successSound) successSound.triggerAttackRelease('G5', '8n');
                const earnedCoins = targetText.length * 5;
                gameState.coins += earnedCoins;
                showCoinEffect(earnedCoins);
                updateCoinDisplay();
                saveGameState();
                totalTyped += targetText.length;
                totalCorrect += targetText.length;
                currentWordIndex++;
                wordInput.value = '';
                wordInput.classList.remove('border-green-500', 'focus:border-green-500');
                wordDisplay.classList.add('correct-animation');
                setTimeout(() => wordDisplay.classList.remove('correct-animation'), 500);
                showNextWord();
                updateStats();
             }
        }

        function endGame() {
            isPlaying = false;
            clearInterval(timer);
            wordInput.disabled = true;
            wordDisplay.innerHTML = "<span class='text-green-500'>ğŸ‰ ë ˆë²¨ ì™„ë£Œ! ğŸ‰</span>";
            imageDisplay.textContent = 'ğŸ‘';
            updateKeyboardHighlight();
            showMessageBox('ì°¸ ì˜í–ˆì–´ìš”!', `ìµœì¢… íƒ€ìˆ˜ëŠ” ${wpmEl.innerText}, ì •í™•ë„ëŠ” ${accuracyEl.innerText}% ì…ë‹ˆë‹¤!`);
        }

        // --- Stat & Display Functions ---
        function resetStats() {
            clearInterval(timer);
            time = 0;
            totalTyped = 0;
            totalCorrect = 0;
            accuracyEl.innerText = '100';
            wpmEl.innerText = '0';
        }

        function showNextWord() {
            imageDisplay.textContent = '';
            if (currentWordIndex >= currentLevelWords.length) {
                endGame();
                return;
            }
            const word = currentLevelWords[currentWordIndex];
            wordDisplay.innerHTML = word.split('').map(char => `<span>${char}</span>`).join('');
            let foundEmoji = null;
            for (const animal in wordToEmoji) {
                if (word.includes(animal)) {
                    foundEmoji = wordToEmoji[animal];
                    break;
                }
            }
            if (foundEmoji) {
                imageDisplay.textContent = foundEmoji;
            }
            updateKeyboardHighlight();
        }

        function updateTime() {
            time++;
            updateStats();
        }

        function updateStats() {
            if (time > 0) {
                const wpm = Math.round((totalTyped / 5) / (time / 60));
                wpmEl.innerText = isNaN(wpm) ? 0 : wpm;
            }
            const accuracy = totalTyped > 0
                ? Math.round((totalCorrect / totalTyped) * 100)
                : 100;
            accuracyEl.innerText = isNaN(accuracy) ? 100 : accuracy;
        }

        function showMessageBox(title, text) {
            const el = document.getElementById('message-box');
            el.querySelector('#message-title').innerText = title;
            el.querySelector('#message-text').innerText = text;
            el.classList.remove('hidden');
        }

        function hideMessageBox() {
            document.getElementById('message-box').classList.add('hidden');
            gameArea.classList.add('hidden');
            levelSelection.classList.remove('hidden');
        }

        // --- Keyboard Highlight Functions ---
        function decompose(char) {
            if (!char) return [];
            if (char === ' ') return [' '];
            const charCode = char.charCodeAt(0);
            if (charCode >= 0xAC00 && charCode <= 0xD7A3) {
                const hangulIndex = charCode - 0xAC00;
                const chosungIndex = Math.floor(hangulIndex / (21 * 28));
                const jungsungIndex = Math.floor((hangulIndex % (21 * 28)) / 28);
                const jongsungIndex = hangulIndex % 28;
                const jamos = [CHOSUNG_LIST[chosungIndex], JUNGSUNG_LIST[jungsungIndex]];
                if (jongsungIndex > 0) {
                    jamos.push(JONGSUNG_LIST[jongsungIndex]);
                }
                return jamos;
            }
            if (Object.keys(JAMO_TO_KEY).includes(char)) {
                return [char];
            }
            return [char];
        }

        function updateKeyboardHighlight() {
            keyboardKeys.forEach(k => k.classList.remove('key-highlight'));
            const targetText = currentLevelWords[currentWordIndex] || '';
            const typedText = wordInput.value;
            let correctLen = 0;
            while (correctLen < typedText.length && typedText[correctLen] === targetText[correctLen]) {
                correctLen++;
            }
            if (correctLen >= targetText.length) return;

            const targetChar = targetText[correctLen];
            const targetJamos = decompose(targetChar);

            // Find the current jamo being typed
            const typedJamos = decompose(typedText[correctLen] || '');

            let nextJamo = null;
            if (typedJamos.length === 0) {
                nextJamo = targetJamos[0];
            } else {
                let foundMatch = false;
                for (let i = 0; i < typedJamos.length; i++) {
                    if (typedJamos[i] !== targetJamos[i]) {
                        // User typed something wrong, highlight the correct one
                        nextJamo = targetJamos[i];
                        foundMatch = true;
                        break;
                    }
                }
                if (!foundMatch && typedJamos.length < targetJamos.length) {
                    nextJamo = targetJamos[typedJamos.length];
                }
            }

            if (nextJamo) {
                const keyData = JAMO_TO_KEY[nextJamo];
                if (keyData) {
                    const keysToHighlight = Array.isArray(keyData) ? keyData : [keyData];
                    keysToHighlight.forEach(k => {
                        const keyElement = document.querySelector(`.key[data-key="${k.toLowerCase()}"]`);
                        if (keyElement) {
                             keyElement.classList.add('key-highlight');
                        }
                    });
                }
            }
        }
        
        function handleKeyboardPress(e) {
            const key = e.key.toLowerCase();
            const keyElement = document.querySelector(`.key[data-key="${key}"]`);
            if (keyElement) {
                keyElement.classList.add('key-active');
            } else if (e.key === 'Shift') {
                document.querySelectorAll(`.key[data-key="shift"]`).forEach(el => el.classList.add('key-active'));
            }
        }

        function handleKeyboardRelease(e) {
            const key = e.key.toLowerCase();
            const keyElement = document.querySelector(`.key[data-key="${key}"]`);
            if (keyElement) {
                keyElement.classList.remove('key-active');
            } else if (e.key === 'Shift') {
                document.querySelectorAll(`.key[data-key="shift"]`).forEach(el => el.classList.remove('key-active'));
            }
        }

        // --- Sound Functions ---
        function setupSounds() {
            musicSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
            const melody = ['C4', 'E4', 'G4', 'E4', 'D4', 'F4', 'A4', 'F4'];
            musicSequence = new Tone.Sequence((time, note) => { musicSynth.triggerAttackRelease(note, 0.1, time); }, melody, '4n');
            Tone.Transport.bpm.value = 100;
            musicSequence.loop = true;

            tickSound = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: 'triangle' },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.1 }
            }).toDestination();
            tickSound.set({ volume: -12 });

            errorSound = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: 'square' },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 }
            }).toDestination();
            errorSound.set({ volume: -8 });

            successSound = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: 'sine' },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 }
            }).toDestination();
            successSound.set({ volume: -6 });
        }

        async function toggleMusic() {
            if (Tone.context.state !== 'running') {
                await Tone.start();
            }
            if (isMusicPlaying) {
                Tone.Transport.stop();
                musicToggleBtn.textContent = 'ğŸ”‡';
            } else {
                Tone.Transport.start();
                musicSequence.start(0);
                musicToggleBtn.textContent = 'ğŸ”ˆ';
            }
            isMusicPlaying = !isMusicPlaying;
        }

        // --- Character & Shop Functions ---
        function showCoinEffect(amount) {
            const c = document.getElementById('coin-effect-container');
            const e = document.createElement('div');
            e.className = 'coin-effect';
            e.innerText = `+${amount} ğŸ’°`;
            c.appendChild(e);
            setTimeout(() => { e.remove(); }, 1000);
        }

        function loadGameState() {
            const d = JSON.parse(localStorage.getItem('typingGameState'));
            gameState = {
                coins: 0,
                purchasedItems: [],
                equippedItems: { hat: null, glasses: null },
                ...d
            };
            updateCoinDisplay();
            renderCharacter();
        }

        function saveGameState() {
            localStorage.setItem('typingGameState', JSON.stringify(gameState));
        }

        function updateCoinDisplay() {
            coinDisplay.innerText = gameState.coins;
            shopCoinDisplay.innerText = gameState.coins;
        }

        function renderCharacter() {
            hatSlot.innerHTML = '';
            glassesSlot.innerHTML = '';
            if (gameState.equippedItems.hat) {
                const i = shopItems.find(it => it.id === gameState.equippedItems.hat);
                if (i) hatSlot.innerHTML = `<div class="${i.className}"></div>`;
            }
            if (gameState.equippedItems.glasses) {
                const i = shopItems.find(it => it.id === gameState.equippedItems.glasses);
                if (i) glassesSlot.innerHTML = `<div class="${i.className}"></div>`;
            }
        }

        function openShop() {
            shopItemsGrid.innerHTML = '';
            shopItems.forEach(item => {
                const isPurchased = gameState.purchasedItems.includes(item.id);
                const isEquipped = gameState.equippedItems[item.type] === item.id;
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow';
                let btn;

                if (isEquipped) {
                    btn = `<button class="w-full mt-2 bg-gray-400 text-white py-1 rounded cursor-not-allowed" disabled>ì¥ì°©ì¤‘</button>`;
                } else if (isPurchased) {
                    btn = `<button data-item-id="${item.id}" data-item-type="${item.type}" class="w-full mt-2 bg-green-500 hover:bg-green-600 text-white py-1 rounded equip-btn">ì¥ì°©í•˜ê¸°</button>`;
                } else {
                    btn = `<button data-item-id="${item.id}" class="w-full mt-2 bg-blue-500 hover:bg-blue-600 text-white py-1 rounded buy-btn">ğŸ’° ${item.price}</button>`;
                }

                card.innerHTML = `
                    <div class="w-20 h-20 bg-gray-200 mx-auto rounded-md flex items-center justify-center font-bold text-gray-500">${item.name}</div>
                    ${btn}
                `;
                shopItemsGrid.appendChild(card);
            });
            updateCoinDisplay();
            shopModal.classList.remove('hidden');
        }

        function handleShopClick(e) {
            if (e.target.matches('.buy-btn')) {
                const itemId = e.target.dataset.itemId;
                const item = shopItems.find(it => it.id === itemId);
                if (gameState.coins >= item.price) {
                    gameState.coins -= item.price;
                    gameState.purchasedItems.push(item.id);
                    updateCoinDisplay();
                    saveGameState();
                    openShop();
                } else {
                    showMessageBox('ì½”ì¸ ë¶€ì¡±!', 'ì•„ì´í…œì„ êµ¬ë§¤í•˜ê¸° ìœ„í•œ ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                }
            } else if (e.target.matches('.equip-btn')) {
                const itemId = e.target.dataset.itemId;
                const itemType = e.target.dataset.itemType;
                gameState.equippedItems[itemType] = itemId;
                saveGameState();
                renderCharacter();
                openShop();
            }
        }

        // --- Start the engine! ---
        init();
    </script>
</body>
</html>
